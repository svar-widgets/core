<script>
	import { untrack } from "svelte";
	import Panel from "./calendar/Panel.svelte";
	import { configs } from "./calendar/helpers";

	let {
		start = $bindable(),
		end = $bindable(),
		done = false,
		current,
		months = 2,
		markers = null,
		buttons = true,
		onchange,
	} = $props();

	function addMonth(l, diff, rPrev) {
		const r = new Date(l);
		r.setMonth(r.getMonth() + diff);
		if (rPrev && r.valueOf() == rPrev.valueOf()) return rPrev;
		return r;
	}

	let leftCurrent = $state(),
		rightCurrent = $state();

	$effect.pre(() => {
		start;
		current;
		untrack(() => {
			onLeft(start ? new Date(start) : current || new Date());
		});
	});

	function onLeft(v) {
		leftCurrent = v;
		if (leftCurrent) rightCurrent = addMonth(leftCurrent, 1);
	}
	function onRight(v) {
		rightCurrent = v;
		if (rightCurrent) leftCurrent = addMonth(rightCurrent, -1);
	}

	function doShift({ diff, type }) {
		const obj = configs[type];
		if (diff > 0) {
			onRight(obj.next(rightCurrent));
		} else if (diff < 0) {
			onLeft(obj.prev(leftCurrent));
		}
	}

	function doChangeStart(v) {
		selectChange(v);
		if (start) onLeft(new Date(start));
	}
	function doChangeEnd(v) {
		selectChange(v);
		if (end) onRight(new Date(end));
	}
	function selectChange(ev) {
		const v = ev.value;
		const final = v === -1;
		if (!final) {
			if (ev.select) {
				if (!start || end) {
					start = v;
					end = null;
				} else {
					if (start > v) {
						end = start;
						start = v;
					} else {
						end = v;
					}
				}
			} else {
				if (!v) {
					start = end = null;
				} else {
					start = new Date(v);
					end = new Date(v);
				}
			}
		}

		if (final || !done) onchange && onchange({ start, end });
	}
</script>

{#if months == 1}
	<Panel
		value={{ start: start, end: end }}
		current={leftCurrent}
		{markers}
		{done}
		{buttons}
		part="both"
		onshift={doShift}
		onchange={doChangeStart}
	/>
{:else}
	<div class="wx-rangecalendar">
		<div class="wx-half">
			<Panel
				value={{ start: start, end: end }}
				current={leftCurrent}
				{markers}
				buttons={false}
				part="left"
				onshift={doShift}
				onchange={doChangeStart}
			/>
		</div>
		<div class="wx-half">
			<Panel
				value={{ start: start, end: end }}
				current={rightCurrent}
				{markers}
				{done}
				{buttons}
				part="right"
				onshift={doShift}
				onchange={doChangeEnd}
			/>
		</div>
	</div>
{/if}

<style>
	.wx-rangecalendar {
		display: flex;
		padding-bottom: var(--wx-calendar-padding);
	}

	.wx-half {
		flex: 1;
	}
</style>
